# Malcolm Interactive Detail Levels

## Core Concepts

1. **Always Store Everything** - Full request/response saved to JSON regardless of display level
2. **In-Memory History** - Last 100 requests kept for instant redraw on level change
3. **Screen Management** - Clear and redraw entire terminal on level switch
4. **Keyboard Input** - Non-blocking listener for +/- keys

## Architecture Overview

```
src/
  domain/
    entities/
      http-exchange.ts        # Request + Response + metadata
    value-objects/
      detail-level.ts         # Level 1-6 enum
      http-status-category.ts # Status code classification
    ports/
      exchange-store.ts       # Interface for persistence
      terminal-ui.ts          # Interface for screen control
      keyboard-input.ts       # Interface for key events
  application/
    use-cases/
      proxy-request.ts        # Enhanced: stores exchange, notifies UI
      change-detail-level.ts  # Handle +/- level changes
    services/
      exchange-history.ts     # Circular buffer of last N exchanges
      exchange-formatter.ts   # Format exchange at given level
  infrastructure/
    file-exchange-store.ts    # JSON file storage in temp dir
    ansi-terminal-ui.ts       # ANSI escape codes for screen control
    raw-keyboard-input.ts     # Raw mode stdin for key capture
    color-scheme.ts           # Status code â†’ ANSI color mapping
  cli/
    main.ts                   # Wire everything, start event loop
```

## Implementation Phases

### Phase 1: Domain Layer Foundation

**`HttpExchange` entity** - Immutable record of a proxied request:

```typescript
interface HttpExchange {
  id: string; // UUID for file storage
  timestamp: Date;
  request: {
    method: string;
    path: string;
    headers: Record<string, string>;
    body: string | null;
  };
  response: {
    statusCode: number | null; // null = unreachable
    headers: Record<string, string>;
    body: string | null;
  } | null; // null = no response yet
  durationMs: number | null;
}
```

**`DetailLevel` value object** - Levels 1-6 with increment/decrement:

```typescript
class DetailLevel {
  static readonly MIN = 1;
  static readonly MAX = 6;
  increment(): DetailLevel;
  decrement(): DetailLevel;
}
```

**`HttpStatusCategory`** - Classify status for coloring:

- `Unreachable` (violet) - null/connection failed
- `Informational` (grey) - 1xx
- `Success` (green) - 2xx
- `Redirect` (blue) - 3xx
- `ClientError` (orange) - 4xx
- `ServerError` (red) - 5xx

### Phase 2: Screen Management (Priority)

**`TerminalUI` interface** (domain port):

```typescript
interface TerminalUI {
  clearScreen(): void;
  moveCursor(row: number, col: number): void;
  write(text: string): void;
  writeLine(text: string): void;
  getSize(): { rows: number; cols: number };
  enableRawMode(): void;
  disableRawMode(): void;
}
```

**`AnsiTerminalUI` implementation**:

- Use ANSI escape codes: `\x1b[2J` (clear), `\x1b[H` (home), `\x1b[{row};{col}H` (move)
- Track terminal size via `process.stdout.columns/rows`
- Handle resize events via `process.stdout.on('resize')`

**`KeyboardInput` interface**:

```typescript
interface KeyboardInput {
  onKeyPress(handler: (key: string) => void): void;
  start(): void;
  stop(): void;
}
```

**`RawKeyboardInput` implementation**:

- Set `process.stdin.setRawMode(true)` to capture individual keys
- Map `+`/`=` to increment, `-`/`_` to decrement
- Map `q`/`Ctrl+C` to quit

### Phase 3: Exchange Formatting

**`ExchangeFormatter` service** - Format an exchange at a given level:

| Level | Output |

|-------|--------|

| 1 | `.` (single dot) |

| 2 | `[14:32:05] 200` |

| 3 | `[14:32:05] 200 GET /api/users?page=2` |

| 4 | Level 3 + all headers (multi-line) |

| 5 | Level 4 + truncated body (512 chars) |

| 6 | Level 4 + full body |

Each formatted output includes ANSI color codes based on status category.

### Phase 4: History and Storage

**`ExchangeHistory` service** - Circular buffer:

- Configurable max size (default 100, via `--history` CLI arg)
- `add(exchange)` - Add new, evict oldest if full
- `getAll()` - Return all in chronological order
- Event emitter for new exchanges

**`FileExchangeStore` implementation**:

- Store in `{os.tmpdir()}/malcolm/{sessionId}/{exchangeId}.json`
- Session ID generated at startup (timestamp-based)
- Async write (don't block proxy)

### Phase 5: Screen Redraw Logic

**Redraw algorithm**:

1. Clear screen
2. Get terminal height
3. Get all exchanges from history
4. Format each at current level
5. Calculate total lines needed
6. If exceeds terminal: show only newest that fit (auto-scroll)
7. Write formatted lines with colors

**Redraw triggers**:

- New request proxied
- Level changed (+/-)
- Terminal resized

### Phase 6: Enhanced CLI

New arguments:

- `--level <1-6>` - Starting detail level (default: 3)
- `--history <n>` - Max requests to keep (default: 100)

## Color Scheme (ANSI)

```typescript
const colors = {
  unreachable: "\x1b[35m", // Magenta/Violet
  info: "\x1b[90m", // Grey
  success: "\x1b[32m", // Green
  redirect: "\x1b[34m", // Blue
  clientError: "\x1b[33m", // Yellow/Orange
  serverError: "\x1b[31m", // Red
  reset: "\x1b[0m",
};
```

## Key Files to Create/Modify

| File | Purpose |

|------|---------|

| [`src/domain/entities/http-exchange.ts`](src/domain/entities/http-exchange.ts) | Exchange data structure |

| [`src/domain/value-objects/detail-level.ts`](src/domain/value-objects/detail-level.ts) | Level 1-6 handling |

| [`src/domain/ports/terminal-ui.ts`](src/domain/ports/terminal-ui.ts) | Screen control interface |

| [`src/domain/ports/keyboard-input.ts`](src/domain/ports/keyboard-input.ts) | Key event interface |

| [`src/application/services/exchange-formatter.ts`](src/application/services/exchange-formatter.ts) | Level-based formatting |

| [`src/application/services/exchange-history.ts`](src/application/services/exchange-history.ts) | Circular buffer |

| [`src/infrastructure/ansi-terminal-ui.ts`](src/infrastructure/ansi-terminal-ui.ts) | ANSI implementation |

| [`src/infrastructure/raw-keyboard-input.ts`](src/infrastructure/raw-keyboard-input.ts) | Raw stdin handling |

| [`src/infrastructure/file-exchange-store.ts`](src/infrastructure/file-exchange-store.ts) | JSON file persistence |

## Test Strategy

1. **Unit tests** for `DetailLevel`, `HttpStatusCategory`, `ExchangeFormatter`, `ExchangeHistory`
2. **Integration test** for full redraw cycle with mock terminal
3. **Manual testing** for actual keyboard interaction and colors
