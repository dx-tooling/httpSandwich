# Malcolm MVP Implementation

## Architecture Overview

Following clean architecture, the MVP will have:

```
src/
  domain/
    ports/output-writer.ts      # Interface for writing output (dot)
    value-objects/address.ts    # Host:port value object
  application/
    use-cases/proxy-request.ts  # Core proxy logic use case
  infrastructure/
    http-proxy-server.ts        # Node.js HTTP server implementation
    console-output-writer.ts    # stdout implementation
  cli/
    argument-parser.ts          # Parse --from and --to args
    main.ts                     # Entry point, wires everything
```

## Components to Implement

### 1. Domain Layer

**`Address` value object** - Represents a host:port combination:

- Parse from string (`"localhost:5009"` or `"5009"`)
- Validate port range (1-65535)
- Default host to `localhost` when only port provided

**`OutputWriter` interface** - Abstraction for output:

```typescript
interface OutputWriter {
  write: (text: string) => void;
}
```

### 2. Application Layer

**`ProxyRequestHandler`** - Orchestrates the proxying:

- Receives incoming request details
- Forwards to target
- Calls `OutputWriter.write(".")` on success
- Returns response to caller

### 3. Infrastructure Layer

**`HttpProxyServer`** - Node.js HTTP server:

- Binds to source port
- Forwards requests using `node:http`
- Returns 502 on target unreachable (silent)

**`ConsoleOutputWriter`** - Implements `OutputWriter`:

- Writes to `process.stdout`

### 4. CLI Layer

**`ArgumentParser`** - Parses CLI arguments:

- `--from <port>` (required) - Source port to listen on
- `--to <host:port>` (required) - Target to proxy to
- Returns typed config or error

**`main.ts`** - Wires components and starts server

## CLI Usage

```bash
malcolm --from 8000 --to 5009           # Proxies localhost:8000 → localhost:5009
malcolm --from 8000 --to localhost:5009 # Same as above
malcolm --from 8000 --to 192.168.1.5:80 # Proxies to different host
```

## Test Plan

### Unit Tests

1. **Address value object** (`tests/unit/domain/address.test.ts`)
   - Parse "5009" → localhost:5009
   - Parse "localhost:5009" → localhost:5009
   - Parse "192.168.1.5:80" → 192.168.1.5:80
   - Reject invalid port (0, 65536, -1, "abc")
   - Reject invalid format

2. **ArgumentParser** (`tests/unit/cli/argument-parser.test.ts`)
   - Parse valid `--from 8000 --to 5009`
   - Parse valid `--from 8000 --to localhost:5009`
   - Reject missing --from
   - Reject missing --to
   - Reject invalid port values

3. **ProxyRequestHandler** (`tests/unit/application/proxy-request.test.ts`)
   - Calls OutputWriter.write(".") on successful proxy
   - Does not write on failure

4. **ConsoleOutputWriter** (`tests/unit/infrastructure/console-output-writer.test.ts`)
   - Writes to stdout without newline

### Integration Tests

5. **Full proxy flow** (`tests/integration/proxy.test.ts`)
   - Start mock target server
   - Start Malcolm proxy
   - Send request to proxy
   - Verify request reaches target
   - Verify response returned to client
   - Verify dot was written

## Key Files

| File | Purpose |

|------|---------|

| [`src/domain/value-objects/address.ts`](src/domain/value-objects/address.ts) | Host:port parsing and validation |

| [`src/domain/ports/output-writer.ts`](src/domain/ports/output-writer.ts) | Output abstraction interface |

| [`src/application/use-cases/proxy-request.ts`](src/application/use-cases/proxy-request.ts) | Proxy orchestration |

| [`src/infrastructure/http-proxy-server.ts`](src/infrastructure/http-proxy-server.ts) | HTTP server implementation |

| [`src/infrastructure/console-output-writer.ts`](src/infrastructure/console-output-writer.ts) | stdout writer |

| [`src/cli/argument-parser.ts`](src/cli/argument-parser.ts) | CLI argument parsing |

| [`src/cli/main.ts`](src/cli/main.ts) | Application entry point |
