# httpSandwich TUI Screen Implementation

## Problem

Current implementation has UX issues:

- Screen clearing incomplete - old content visible when scrolling
- Multi-line levels (4+) don't render correctly
- Terminal scroll buffer shows old output
- No proper viewport management

## Solution

Use a proper TUI approach with:

1. **Alternate screen buffer** - isolates httpSandwich from terminal history
2. **Fixed header** - shows proxy info, current level, storage path
3. **Fixed footer** - shows controls (+/- level, q quit)
4. **Scrollable viewport** - exchanges rendered in middle area only

## Screen Layout

```
┌─────────────────────────────────────────────────────────┐
│ httpSandwich ← localhost:8000 → localhost:5009  [Level 3] │  ← Header (line 1)
├─────────────────────────────────────────────────────────┤
│                                                         │
│ [14:32:05] 200 GET /api/users                          │  ← Viewport
│ [14:32:06] 201 POST /api/users                         │    (rows 2 to n-2)
│ [14:32:07] 404 GET /api/missing                        │
│                                                         │
├─────────────────────────────────────────────────────────┤
│ +/- level • q quit • 3/100 requests                     │  ← Footer (last line)
└─────────────────────────────────────────────────────────┘
```

## Implementation Changes

### 1. Enhance AnsiTerminalUI

Add alternate screen buffer support:

```typescript
enterAlternateScreen(): void;   // \x1b[?1049h
exitAlternateScreen(): void;    // \x1b[?1049l
```

### 2. Create TuiLayout Component

New component to manage screen regions:

- `header: { row: 1, height: 1 }`
- `viewport: { row: 2, height: terminalRows - 3 }`
- `footer: { row: terminalRows, height: 1 }`

Responsibilities:

- Calculate viewport dimensions on resize
- Clip exchange output to viewport bounds
- Render header/footer consistently

### 3. Refactor ScreenRenderer

Change from "append and clear" to "render viewport":

1. On any redraw trigger:
   - Clear viewport area only (not entire screen)
   - Calculate which exchanges fit in viewport
   - Render visible exchanges with proper clipping
   - Re-render header/footer (they stay fixed)

2. Smart viewport calculation:
   - For level 1: Many dots can fit
   - For levels 2-3: One line per exchange
   - For levels 4-6: Multi-line, calculate line count per exchange

### 4. Update Main Lifecycle

```typescript
// On start
terminal.enterAlternateScreen();
terminal.hideCursor();
renderInitialScreen();

// On shutdown
terminal.exitAlternateScreen();
terminal.showCursor();
// Original terminal content restored automatically
```

## Key Files to Modify

| File | Changes |

|------|---------|

| [`src/infrastructure/ansi-terminal-ui.ts`](src/infrastructure/ansi-terminal-ui.ts) | Add alternate screen methods |

| [`src/application/services/screen-renderer.ts`](src/application/services/screen-renderer.ts) | Complete rewrite for TUI layout |

| [`src/cli/main.ts`](src/cli/main.ts) | Use alternate screen on start/exit |

## ANSI Codes Reference

```typescript
const ANSI = {
  ALTERNATE_SCREEN_ON: "\x1b[?1049h",
  ALTERNATE_SCREEN_OFF: "\x1b[?1049l",
  CLEAR_LINE: "\x1b[2K",
  CURSOR_TO: (row: number, col: number) => `\x1b[${row};${col}H`,
};
```

## Benefits

1. **Clean slate** - No terminal history pollution
2. **Proper viewport** - Multi-line levels render correctly
3. **Fixed chrome** - Header/footer always visible
4. **Exit cleanly** - Original terminal restored on quit
